# Security and Bug Fixes - December 13, 2025

## Overview

This update addresses security vulnerabilities, fixes numerous bugs, improves error handling, and optimizes performance across the codebase. All fixes were identified through Churn's self-analysis and have been verified with TypeScript type-checking.

## Security Fixes

### Command Injection Prevention

Two critical command injection vulnerabilities were fixed:

**src/engine/differential.ts**
- Changed `execSync` with string template to `execFileSync` with array arguments
- File paths are now passed as separate arguments, preventing shell interpretation

**src/engine/handoff.ts**
- Added `escapeShellArg()` helper function for proper shell escaping
- Applied to all agent adapter `buildCommand` methods (Claude, Cursor, Gemini, Codex, Droid)
- File paths and working directories are now properly escaped

## Bug Fixes

### Race Condition in Parallel Analysis (src/engine/analysis.ts)
- Added `CacheLock` class to serialize cache updates during parallel file processing
- Prevents cache corruption when multiple files finish analysis simultaneously

### Code Age Calculation (src/engine/codeage.ts)
- Fixed age calculation to use `firstDate` (file creation) instead of `lastDate`
- Now correctly reports how old the code actually is, not when it was last modified

### Global Regex State (src/engine/dependencies.ts)
- Changed from global regex patterns to creating new regex instances per call
- Fixes incorrect import extraction when `extractImports` is called multiple times

### ANSI Color Handling (src/theme.ts)
- Added `strip-ansi` import for calculating visible string width
- `createBox()` now correctly calculates padding with colored strings

### CommonJS Require (src/engine/prompts.ts)
- Replaced `require("./differential.js")` with ESM `import` statement
- Ensures compatibility with bundled builds

### Memory Leaks

**src/components/ModelSelect.tsx**
- Moved setTimeout cleanup to useEffect with proper cleanup function
- Added `completedConfig` state to separate selection from completion

**src/components/AskConsole.tsx**
- Added `timeoutRef` for proper timeout cleanup on unmount
- Wrapped `runAsk` in useCallback with correct dependencies

### React Hooks Issues

**src/components/VirtualizedList.tsx**
- Used ref pattern for `onSelectionChange` callback to avoid effect re-triggering
- Fixed interface to use `unknown` instead of `any` for type safety

**src/components/ConfirmRun.tsx**
- Fixed key parameter type to use Ink's `Key` type instead of `any`

**src/components/StartMenu.tsx**
- Wrapped useInput callback in `useCallback` with proper dependencies

**src/components/AnalysisSummary.tsx**
- Wrapped `handleInput` in `useCallback` with all required dependencies

## Error Handling Improvements

### src/commands/ask.ts
- Added try-catch around `processAsk` with descriptive error messages
- Added try-catch around `saveAskSession` with path-specific errors
- Nested try-catch for optional repo info (fails gracefully)

### src/components/AgentOnboarding.tsx
- Added error state and try-catch in `handleSelect`
- Displays error message in UI when config save fails

### src/components/HandoffSettings.tsx
- Added error state with loading error handling
- Added bounds checking for array indexes
- Added try-catch in `handleSave`

### src/components/ExportPanel.tsx
- Wrapped `performExport` in try-catch with error display
- Uses useCallback for proper memoization

### src/components/RunConsole.tsx
- Added error state and error view UI
- Wrapped analysis in try-catch with user-friendly error display
- Shows "Analysis Failed" screen instead of crashing

### src/engine/git.ts
- Added `GitError` class for git-specific errors
- Added graceful error handling in `getFileDiff`
- Fixed `countRepoFiles` to handle permission errors and symlinks
- Added exclusion for common non-source directories (.next, dist, build, coverage)

### src/engine/handoff.ts
- Added warning logs for unreadable files during patch generation
- Added line range validation before processing

## Performance Optimizations

### src/components/Logo.tsx
- Pre-computed gradient logo at module load time
- Wrapped component in `React.memo` to prevent unnecessary re-renders

### src/engine/grouping.ts
- Added file metadata cache (`metadataCache`) to avoid repeated path operations
- Added `clearGroupingCache()` function for cache management
- Reduces O(n^2) path operations to O(n)

### src/engine/context.ts
- Changed sequential file existence checks to parallel `Promise.all`
- Package managers, linter configs, and test directories checked in parallel
- Significantly faster project context detection

### src/engine/reports.ts
- Changed sequential report loading to parallel with `Promise.all`
- Loads both file content and stats in parallel per file
- Uses proper type filtering with `NonNullable`

## Files Changed

| File | Change Type |
|------|-------------|
| src/engine/differential.ts | SECURITY FIX |
| src/engine/handoff.ts | SECURITY FIX, ERROR HANDLING |
| src/theme.ts | BUG FIX |
| src/commands/ask.ts | ERROR HANDLING |
| src/components/AgentOnboarding.tsx | ERROR HANDLING |
| src/components/AskConsole.tsx | BUG FIX (memory leak) |
| src/components/ConfirmRun.tsx | BUG FIX (types) |
| src/components/HandoffSettings.tsx | ERROR HANDLING |
| src/components/Logo.tsx | OPTIMIZATION |
| src/components/ModelSelect.tsx | BUG FIX (memory leak) |
| src/components/StartMenu.tsx | BUG FIX (hooks) |
| src/components/VirtualizedList.tsx | BUG FIX (hooks) |
| src/components/ExportPanel.tsx | ERROR HANDLING |
| src/components/RunConsole.tsx | ERROR HANDLING |
| src/components/AnalysisSummary.tsx | BUG FIX (hooks) |
| src/engine/codeage.ts | BUG FIX |
| src/engine/dependencies.ts | BUG FIX |
| src/engine/git.ts | ERROR HANDLING, OPTIMIZATION |
| src/engine/grouping.ts | OPTIMIZATION |
| src/engine/analysis.ts | BUG FIX (race condition) |
| src/engine/context.ts | OPTIMIZATION |
| src/engine/prompts.ts | BUG FIX (ESM) |
| src/engine/reports.ts | OPTIMIZATION |

## Testing Checklist

- [x] TypeScript type-check passes (`bun run type-check`)
- [ ] Run analysis on a project and verify completion
- [ ] Verify error handling by testing with missing API keys
- [ ] Verify parallel analysis doesn't corrupt cache
- [ ] Test Logo component doesn't re-render unnecessarily
- [ ] Test VirtualizedList selection changes work correctly
- [ ] Test agent handoff with file paths containing special characters
- [ ] Verify code age metrics show correct values

## Summary

This release includes:
- **2 security fixes** (command injection)
- **8 bug fixes** (race conditions, memory leaks, hooks, calculations)
- **6 error handling improvements** (graceful failures, user-friendly messages)
- **5 performance optimizations** (caching, parallelization, memoization)

All changes maintain backward compatibility and pass TypeScript type-checking.
